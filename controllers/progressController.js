/* ████████████████████████████████████████████████████████████████████████████████████████████████████
REQUIRE
████████████████████████████████████████████████████████████████████████████████████████████████████ */
const Progress = require("./../models/progressModel");
const Guild = require("./../models/guildModel");
const catchAsync = require("./../utils/catchAsync");
// const AppError = require("./../utils/appError");
const factory = require("./handlerFactory");

/* ████████████████████████████████████████████████████████████████████████████████████████████████████
PROGRESS ROUTE HANDLERS
████████████████████████████████████████████████████████████████████████████████████████████████████ */
/* ////////////////////////////////////////////////////////////////////////////////////////////////////
GET ALL PROGRESS
//////////////////////////////////////////////////////////////////////////////////////////////////// */
exports.getAllProgress = factory.getAll(Progress);

/* ////////////////////////////////////////////////////////////////////////////////////////////////////
GET PROGRESS BY ID
//////////////////////////////////////////////////////////////////////////////////////////////////// */
exports.getProgress = factory.getOne(Progress);

/* ////////////////////////////////////////////////////////////////////////////////////////////////////
CREATE PROGRESS
//////////////////////////////////////////////////////////////////////////////////////////////////// */
exports.createProgress = factory.createOne(Progress);

/* ////////////////////////////////////////////////////////////////////////////////////////////////////
PATCH PROGRESS
//////////////////////////////////////////////////////////////////////////////////////////////////// */
exports.patchProgress = factory.patchOne(Progress);

/* ////////////////////////////////////////////////////////////////////////////////////////////////////
DELETE PROGRESS
//////////////////////////////////////////////////////////////////////////////////////////////////// */
exports.deleteProgress = factory.deleteOne(Progress);

/* ////////////////////////////////////////////////////////////////////////////////////////////////////
GET MY PROGRESS
//////////////////////////////////////////////////////////////////////////////////////////////////// */
exports.getMyProgress = catchAsync(async (req, res, next) => {
    const progress = await Progress.find({user: req.user.id});

    const guildIds = progress.map(el => el.guild);
    //select all the tours that id is in tourIds array
    const guilds = await Guild.find({_id: {$in: guildIds}}); 

    res.status(200).json({
        status: "success",
        data: {
            data: guilds,
        },
    });
});